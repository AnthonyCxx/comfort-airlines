<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="stylesheet" href="../css/simulation.css" />

    <link rel="icon" href="../images/logo.png" sizes="any" type="image/png" />
    <script src="../js/flights.js"></script>
  </head>
  <body>
    <div class="container">
      <div id="side-bar">
        <img src="../images/logo.png" id="logo" />
        <div id="icon-area">
          <div class="icon-button">
            <a href="../dashboard/">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="icon icon-tabler icon-tabler-home"
                width="30"
                height="30"
                viewBox="0 0 24 24"
                stroke-width="1"
                stroke="#454545"
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M5 12l-2 0l9 -9l9 9l-2 0" />
                <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
                <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
              </svg>
            </a>
          </div>
          <div class="icon-button">
            <a href="../tickets">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="icon icon-tabler icon-tabler-ticket"
                width="30"
                height="30"
                viewBox="0 0 24 24"
                stroke-width="1"
                stroke="#454545"
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M15 5l0 2" />
                <path d="M15 11l0 2" />
                <path d="M15 17l0 2" />
                <path
                  d="M5 5h14a2 2 0 0 1 2 2v3a2 2 0 0 0 0 4v3a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-3a2 2 0 0 0 0 -4v-3a2 2 0 0 1 2 -2"
                />
              </svg>
            </a>
          </div>
          <div class="icon-button">
            <a href="../map">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="icon icon-tabler icon-tabler-map"
                width="30"
                height="30"
                viewBox="0 0 24 24"
                stroke-width="1"
                stroke="#454545"
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M3 7l6 -3l6 3l6 -3v13l-6 3l-6 -3l-6 3v-13" />
                <path d="M9 4v13" />
                <path d="M15 7v13" />
              </svg>
            </a>
          </div>
          <div class="icon-button">
            <a href="../timetable">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="icon icon-tabler icon-tabler-calendar-time"
                width="30"
                height="30"
                viewBox="0 0 24 24"
                stroke-width="1"
                stroke="#454545"
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path
                  d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4"
                />
                <path d="M18 18m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" />
                <path d="M15 3v4" />
                <path d="M7 3v4" />
                <path d="M3 11h16" />
                <path d="M18 16.496v1.504l1 1" />
              </svg>
            </a>
          </div>
          <div class="icon-button">
            <a href="../reports">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="icon icon-tabler icon-tabler-report-analytics"
                width="32"
                height="32"
                viewBox="0 0 24 24"
                stroke-width="1"
                stroke="#454545"
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path
                  d="M9 5h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2h-2"
                />
                <path
                  d="M9 3m0 2a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v0a2 2 0 0 1 -2 2h-2a2 2 0 0 1 -2 -2z"
                />
                <path d="M9 17v-5" />
                <path d="M12 17v-1" />
                <path d="M15 17v-3" />
              </svg>
            </a>
          </div>
          <div class="icon-button icon-button-current">
            <a href="./">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="icon icon-tabler icon-tabler-plane-departure"
                width="32"
                height="32"
                viewBox="0 0 24 24"
                stroke-width="1"
                stroke="#454545"
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path
                  d="M14.639 10.258l4.83 -1.294a2 2 0 1 1 1.035 3.863l-14.489 3.883l-4.45 -5.02l2.897 -.776l2.45 1.414l2.897 -.776l-3.743 -6.244l2.898 -.777l5.675 5.727z"
                />
                <path d="M3 21h18" />
              </svg>
            </a>
          </div>
        </div>
        <a href="../" style="margin-bottom: -0.3em">
          <img src="../images/user.jpg" id="user" />
        </a>
      </div>

      <div class="content">
        <div class="header">
          <div class="dropdown-container" id="dropdownContainer">
            <!-- Dropdown content -->
            <div class="dropdown-content">
              <!-- Placeholder content -->
              <div id="day-unit">
                <div id="day-counter"><h3 id="day">Day 1</h3></div>
                <div id="time-counter"><h3 id="time">5:00am</h3></div>
                <div id="unit-container">
                  <h4 style="margin-top: 1em; padding-bottom: 0em; z-index: 1">
                    Step Size
                  </h4>
                  <input
                    style="width: 2.4em"
                    id="units"
                    autocomplete="off"
                    type="text"
                    placeholder="5"
                    oninput="updateStepSizeFromInput()"
                  />
                </div>
              </div>
              <div id="sim-controls">
                <svg
                  id="skipBack"
                  xmlns="http://www.w3.org/2000/svg"
                  class="icon icon-tabler icon-tabler-player-skip-back-filled"
                  width="32"
                  height="32"
                  viewBox="0 0 24 24"
                  stroke-width="1"
                  stroke="#454545"
                  fill="none"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path
                    d="M19.496 4.136l-12 7a1 1 0 0 0 0 1.728l12 7a1 1 0 0 0 1.504 -.864v-14a1 1 0 0 0 -1.504 -.864z"
                    stroke-width="0"
                    fill="currentColor"
                  />
                  <path
                    d="M4 4a1 1 0 0 1 .993 .883l.007 .117v14a1 1 0 0 1 -1.993 .117l-.007 -.117v-14a1 1 0 0 1 1 -1z"
                    stroke-width="0"
                    fill="currentColor"
                  />
                </svg>
                <svg
                  id="play"
                  style="display: block"
                  xmlns="http://www.w3.org/2000/svg"
                  class="icon icon-tabler icon-tabler-player-play-filled"
                  width="30"
                  height="30"
                  viewBox="0 0 24 24"
                  stroke-width="1"
                  stroke="#454545"
                  fill="none"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path
                    d="M6 4v16a1 1 0 0 0 1.524 .852l13 -8a1 1 0 0 0 0 -1.704l-13 -8a1 1 0 0 0 -1.524 .852z"
                    stroke-width="0"
                    fill="currentColor"
                  />
                </svg>
                <svg
                  id="pause"
                  style="display: none"
                  xmlns="http://www.w3.org/2000/svg"
                  class="icon icon-tabler icon-tabler-player-pause-filled"
                  width="32"
                  height="32"
                  viewBox="0 0 24 24"
                  stroke-width="2.5"
                  stroke="#000000"
                  fill="none"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path
                    d="M9 4h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h2a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2z"
                    stroke-width="0"
                    fill="currentColor"
                  />
                  <path
                    d="M17 4h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h2a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2z"
                    stroke-width="0"
                    fill="currentColor"
                  />
                </svg>
                <svg
                  id="skipForward"
                  xmlns="http://www.w3.org/2000/svg"
                  class="icon icon-tabler icon-tabler-player-skip-forward-filled"
                  width="32"
                  height="32"
                  viewBox="0 0 24 24"
                  stroke-width="1"
                  stroke="#454545"
                  fill="none"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path
                    d="M3 5v14a1 1 0 0 0 1.504 .864l12 -7a1 1 0 0 0 0 -1.728l-12 -7a1 1 0 0 0 -1.504 .864z"
                    width="32"
                    height="32"
                    stroke-width="0"
                    fill="currentColor"
                  />
                  <path
                    d="M20 4a1 1 0 0 1 .993 .883l.007 .117v14a1 1 0 0 1 -1.993 .117l-.007 -.117v-14a1 1 0 0 1 1 -1z"
                    width="32"
                    height="32"
                    stroke-width="0"
                    fill="currentColor"
                  />
                </svg>
              </div>
            </div>
          </div>
          <div
            style="margin-top: -0.75em; margin-bottom: 0.75em; opacity: 80%"
            id="datetime"
          ></div>

          <h1 style="text-align: left; user-select: none">
            Aircraft Simulator
          </h1>

          <div id="simulator" class="boxes">
            <div class="planeBox"></div>
            <div class="planeBox"></div>
            <div class="planeBox"></div>
            <div class="planeBox"></div>
            <div class="planeBox"></div>
            <div class="planeBox"></div>
            <div class="planeBox"></div>
            <div class="planeBox"></div>
            <div class="planeBox"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Get the current date and time
      function getCurrentDateTime() {
        const now = new Date();
        const options = {
          weekday: 'short',
          month: 'short',
          day: 'numeric',
          hour: 'numeric',
          minute: 'numeric',
        };
        return now.toLocaleDateString('en-US', options);
      }

      // Update the date and time every second
      function updateDateTime() {
        const datetimeElement = document.getElementById('datetime');
        if (datetimeElement) {
          datetimeElement.textContent = getCurrentDateTime();
        }
      }

      // Update the date and time initially and then every second
      updateDateTime();
      setInterval(updateDateTime, 1000);
    </script>
    <script src="../js/menu.js"></script>
    <script>
      // Initialize session variables
      sessionStorage.setItem('currentMinute', 0);
      sessionStorage.setItem('stepSize', 5);

      // // Method to convert minutes offset to time format (hh:mm AM/PM)
      // function convertMinutesToTime(minutes) {
      //   const minutesInDay = (minutes + 300) % 1440; // Adjusting for 5:00am start
      //   const hours = Math.floor(minutesInDay / 60);
      //   const mins = minutesInDay % 60;
      //   const ampm = hours >= 12 ? 'pm' : 'am';
      //   const hourFormat = hours === 0 ? 12 : hours > 12 ? hours - 12 : hours;
      //   return `${hourFormat}:${mins.toString().padStart(2, '0')}${ampm}`;
      // }
      function convertMinutesToTime(offset) {
        // Calculations
        var offsetFromStartingDay = offset / 1440;
        var offsetFromCurrentDay =
          offsetFromStartingDay - Math.trunc(offsetFromStartingDay);
        var hoursAndFractionOfHours = 24 * offsetFromCurrentDay;
        var hours =
          Math.trunc(hoursAndFractionOfHours) > 12
            ? Math.trunc(hoursAndFractionOfHours) - 12
            : Math.trunc(hoursAndFractionOfHours);
        var minutes =
          (hoursAndFractionOfHours - Math.trunc(hoursAndFractionOfHours)) * 60;
        var amOrPm = Math.trunc(hoursAndFractionOfHours) > 12 ? 'PM' : 'AM';

        // Format hours
        hours = hours === 0 ? 12 : hours;

        // Output
        return `${hours}:${Math.floor(minutes)
          .toString()
          .padStart(2, '0')}${amOrPm}`;
      }

      // Function to update the day counter and time
      function updateDayCounter() {
        const currentMinute = parseInt(sessionStorage.getItem('currentMinute'));
        if (currentMinute > 1440 * 13.999999) {
          document.getElementById('day').textContent = `Day 14`;
          document.getElementById('time').textContent = `5:00am`;
          return;
        }
        const day = Math.floor(currentMinute / 1440) + 1; // 1440 minutes in a day
        const timeOfDay = convertMinutesToTime(currentMinute);
        document.getElementById('day').textContent = `Day ${day}`;
        document.getElementById('time').textContent = timeOfDay;
      }

      let isPaused = false;
      let intervalId; // Variable to hold the interval ID

      // Function to handle pausing the simulation
      function pauseSimulation() {
        isPaused = true;
        clearInterval(intervalId); // Clear the interval
        document.getElementById('play').style.display = 'block';
        document.getElementById('pause').style.display = 'none';
      }

      // Function to update the session variable every second
      async function updateStepSize() {
        const currentMinute = parseInt(sessionStorage.getItem('currentMinute'));
        if (currentMinute < 1440 * 13.999999) {
          const stepSize = parseInt(sessionStorage.getItem('stepSize'));
          intervalId = setInterval(async function () {
            if (!isPaused) {
              const currentMinute = parseInt(
                sessionStorage.getItem('currentMinute')
              );
              sessionStorage.setItem('currentMinute', currentMinute + stepSize);
              updateDayCounter(); // Update day counter after incrementing minute
              const maxTime = currentMinute + stepSize; // Calculate maxTime
              console.log(maxTime);
              try {
                // Call readFlightsFile and parseFlightsCSV
                const flightsByTailNumber = await readFlightsFile().then(
                  parseFlightsCSV
                );
                // Update planeBox divs with flights up to maxTime
                updatePlaneBoxes(flightsByTailNumber, maxTime);
              } catch (error) {
                console.error('Error:', error);
              }
            }
          }, 100); // Update every second
        }
      }

      // Function to handle play button click
      function playSimulation() {
        document.getElementById('play').style.display = 'none';
        document.getElementById('pause').style.display = 'block';
        isPaused = false;
        updateStepSize();
      }

      // Function to handle skip forward button click
      function skipForward() {
        const stepSize = parseInt(sessionStorage.getItem('stepSize'));
        const currentMinute = parseInt(sessionStorage.getItem('currentMinute'));
        sessionStorage.setItem('currentMinute', currentMinute + stepSize);
        updateDayCounter();
        const maxTime = currentMinute + stepSize; // Calculate maxTime
        updatePlaneBoxes(flightsByTailNumber, maxTime);
        isPaused = false;
        updateStepSize();
      }

      // Function to handle skip back button click
      function skipBack() {
        const stepSize = parseInt(sessionStorage.getItem('stepSize'));
        const currentMinute = parseInt(sessionStorage.getItem('currentMinute'));
        sessionStorage.setItem(
          'currentMinute',
          Math.max(0, currentMinute - stepSize)
        );
        updateDayCounter();
        const maxTime = currentMinute - stepSize; // Calculate maxTime
        updatePlaneBoxes(flightsByTailNumber, maxTime);
      }

      // Add event listener for pause button
      document
        .getElementById('pause')
        .addEventListener('click', pauseSimulation);

      // Add event listener for play button
      document.getElementById('play').addEventListener('click', playSimulation);

      // Add event listeners for skip forward and skip back buttons
      document
        .getElementById('skipForward')
        .addEventListener('click', skipForward);
      document.getElementById('skipBack').addEventListener('click', skipBack);

      // Function to update step size from input field
      function updateStepSizeFromInput() {
        const unitsInput = document.getElementById('units').value;
        sessionStorage.setItem('stepSize', unitsInput);
      }

      // Initial update of day counter
      updateDayCounter();
    </script>
  </body>
</html>
